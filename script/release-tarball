#!/bin/sh

# Copyright (c) 2013, 2014, 2015, 2016 MIT Probabilistic Computing Project.
#
# This file is part of Venture.
#
# Venture is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Venture is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Venture.  If not, see <http://www.gnu.org/licenses/>.

set -Ceu

# Reset the working directory to the directory above the script's path
my_abs_path=$(readlink -f "$0")
root_dirname=$(dirname "$(dirname "$my_abs_path")")
echo "$root_dirname"
cd "$root_dirname"

release=${1:-`python setup.py --version`}
if [ -z "$release" ]; then
    echo >&2 Could not determine a release number, exiting
    exit 1
fi

echo Making a tarball marked version $release

tar --create --verbose --gzip --file ../venture-$release.tgz --directory .. \
    `# Exclude version control metadata` \
    --exclude=.git \
    --exclude=.gitattributes \
    --exclude=.gitignore \
    --exclude=.gitmodules \
    `# Exclude autogenerated artifacts` \
    --exclude=*.bci \
    --exclude=*.bin \
    --exclude=*.com \
    --exclude=*.ext \
    --exclude=*.o \
    --exclude=*.pyc \
    --exclude=*.so \
    --exclude=*~ \
    --exclude=.coverage \
    --exclude=.coverage.* \
    --exclude=.idea \
    --exclude=.ipynb_checkpoints \
    --exclude=CMakeCache.txt \
    --exclude=CMakeFiles \
    --exclude=CMakeLists.txt \
    --exclude=Venturecxx/dist \
    --exclude=Venturecxx/examples/tutorial-2015/gauss_plot.png \
    --exclude=Venturecxx/examples/tutorial-2015/reg-test.csv \
    --exclude=Venturecxx/test/integration/models \
    --exclude=build \
    --exclude=cmake \
    --exclude=cmake_install.cmake \
    --exclude=doc/**/*.aux \
    --exclude=doc/**/*.log \
    --exclude=doc/**/*.out \
    --exclude=doc/**/*.pdf \
    --exclude=env.d \
    --exclude=examples/tutorial-2015/tutorial \
    --exclude=examples/tutorial-2015/tutorial-smoke \
    --exclude=examples/tutorial-2015/vis-*.png \
    --exclude=htmlcov \
    --exclude=python/lib/parser/church_prime/grammar.out \
    --exclude=python/lib/parser/church_prime/grammar.sha256 \
    --exclude=python/lib/parser/venture_script/grammar.out \
    --exclude=python/lib/parser/venture_script/grammar.sha256 \
    --exclude=refman/*.gen \
    --exclude=refman/_build \
    --exclude=refman/_static \
    --exclude=script/jenkins/debian-test-docker/dist \
    --exclude=script/jenkins/pip-test-docker/dist \
    --exclude=tool/logs \
    --exclude=venture-*.tar \
    --exclude=venture-*.tar.bz2 \
    --exclude=venture-*.tar.gz \
    --exclude=venture-*.tgz \
    `# Exclude Jenkins setup from released distribution, for lack of value` \
    --exclude=tool/jenkins \
    `# Exclude plans and road maps,` \
    `# as being even more tenuous than development tools` \
    --exclude=axch-*.org \
    --exclude=v1-pre-scm/**/todo.txt \
    `# Exclude HsVenture because it isn't release quality`\
    `# (also not merged, but compile results appear in my working tree)` \
    --exclude=backend/hs \
    `# Exclude Terminal because it's unused and copyright-intermixed` \
    --exclude=demos/jsripl/Terminal \
    `# TODO Historical exclusion of doc/v1; why?`\
    --exclude=doc/v1 \
    `# Exclude release script to hide exclusion list` \
    --exclude=script/compare-release-content \
    --exclude=script/release-tarball \
    Venturecxx/

md5sum ../venture-$release.tgz
